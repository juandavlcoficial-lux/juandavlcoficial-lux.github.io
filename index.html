<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxe.ai Admin - Panel</title>
    
    <!-- Cargar la librería de Supabase: Forma UMD estable -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <!-- Importar Fuente "Inter" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh; 
            display: flex;
            justify-content: center;
            align-items: center;
            color: #f0f0f0;
        }

        /* Contenedor principal que se muestra/oculta */
        .admin-container {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            
            /* EFECTO GLASSMORPHISM */
            background-color: rgba(26, 26, 46, 0.7); /* #1a1a2e al 70% */
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            text-align: center;
        }

        /* --- ESTILOS DEL LOGIN --- */
        #login-container h1 {
            color: #ffffff;
            font-weight: 700;
            font-size: 1.8rem;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        #login-container p {
            font-size: 1rem;
            color: #a0a0c0;
            margin-bottom: 30px;
        }
        
        .input-field {
            width: calc(100% - 36px); /* 100% - padding */
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 12px;
            padding: 16px 18px; 
            font-size: 1rem; 
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            margin-bottom: 20px;
        }
        
        .input-field::placeholder { color: #a0a0c0; }
        
        .input-field:focus {
            outline: none;
            border-color: #00f5d4;
            box-shadow: 0 0 10px rgba(0, 245, 212, 0.3);
        }
        
        .input-field:disabled {
             background-color: rgba(255, 255, 255, 0.05);
             color: #777;
             cursor: not-allowed;
        }
        
        #login-button {
            width: 100%;
            padding: 16px 18px; 
            background-color: #00f5d4;
            border: none;
            color: #1a1a2e; 
            border-radius: 12px; 
            cursor: pointer; 
            text-align: center;
            font-size: 1rem; 
            font-weight: 700;
            transition: all 0.2s ease;
        }
        
        #login-button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 245, 212, 0.3);
        }

        #login-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #message-box {
            font-size: 0.9rem;
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            display: none; /* Oculto por defecto */
        }
        
        #message-box.success {
            background-color: rgba(0, 245, 212, 0.1);
            color: #00f5d4;
            border: 1px solid #00f5d4;
        }
        
        #message-box.error {
            background-color: rgba(255, 82, 82, 0.1);
            color: #ff5252;
            border: 1px solid #ff5252;
        }
        
        /* NUEVO: Estilos para el separador */
        .divider {
            font-size: 0.9rem;
            color: #a0a0c0;
            display: flex;
            align-items: center;
            text-align: center;
            margin: 25px 0;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .divider span {
            padding: 0 10px;
        }

        /* NUEVO: Estilos para el botón de pass (deshabilitado) */
        #password-login-button {
            width: 100%;
            padding: 16px 18px; 
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #777; 
            border-radius: 12px; 
            cursor: not-allowed; 
            text-align: center;
            font-size: 1rem; 
            font-weight: 700;
        }

        /* --- ESTILOS DEL DASHBOARD (NUEVO) --- */
        #dashboard-container h1 {
            color: #ffffff;
            font-weight: 700;
            font-size: 1.8rem;
            margin-top: 0;
            margin-bottom: 15px;
        }
        #dashboard-container p {
            font-size: 1rem;
            color: #a0a0c0;
            margin-bottom: 30px;
        }
        #user-email {
            color: #00f5d4;
            font-weight: 700;
        }
        #logout-button {
            width: 100%;
            padding: 16px 18px; 
            background-color: transparent;
            border: 1px solid #ff5252; /* Rojo para "peligro" */
            color: #ff5252; 
            border-radius: 12px; 
            cursor: pointer; 
            text-align: center;
            font-size: 1rem; 
            font-weight: 700;
            transition: all 0.2s ease;
        }
        #logout-button:hover {
            background-color: #ff5252;
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(255, 82, 82, 0.3);
        }

        
    </style>
</head>
<body>

    <!-- Contenedor del Login (Puerta) -->
    <div id="login-container" class="admin-container" style="display: none;"> <!-- Oculto por defecto, el JS decide -->
        <h1>Panel de Control</h1>
        <p>Introduce tu email para recibir un enlace de acceso seguro.</p>
        
        <!-- Formulario 1: Magic Link (Funcional) -->
        <form id="login-form-magiclink">
            <input type="email" id="email-input" class="input-field" placeholder="tu-email@dominio.com" required>
            <button type="submit" id="login-button">Enviar Enlace de Acceso</button>
        </form>
        
        <div id="message-box"></div>
        
        <!-- NUEVO: Separador -->
        <div class="divider">
            <span>o</span>
        </div>
        
        <!-- NUEVO: Formulario 2: Contraseña (No funcional) -->
        <form id="login-form-password">
            <input type="email" id="email-input-pass" class="input-field" placeholder="tu-email@dominio.com" disabled>
            <input type="password" id="password-input" class="input-field" placeholder="Contraseña" disabled>
            <button type="button" id="password-login-button" disabled>
                Acceder con Contraseña (Próximamente)
            </button>
        </form>
        
    </div>
    
    <!-- Contenedor del Dashboard (La Oficina) -->
    <div id="dashboard-container" class="admin-container" style="display: none;"> <!-- Oculto por defecto -->
        <h1>¡Bienvenido, Rey!</h1>
        <p>Has iniciado sesión como:<br><span id="user-email">cargando...</span></p>
        
        <div style="margin: 30px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
        
        <!-- Aquí irá el calendario y las citas -->
        <p style="color: #555;">(Próximamente: Aquí va el calendario tocho)</p>
        
        <div style="margin: 30px 0;"></div>
        
        <button id="logout-button">Cerrar Sesión</button>
    </div>

    
    <script type="module">
    
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // === PEGA TUS CLAVES DE SUPABASE AQUÍ ===
            // =================================================================
            const supabaseUrl = 'https://yutttnvtdmjavictfshi.supabase.co'; 
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHR0bnZ0ZG1qYXZpY3Rmc2hpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4Nzg3ODAsImV4cCI6MjA3NjQ1NDc4MH0.XYk79f3HGk9LBODR7KMVK33mPkGamfpKSXKW36RlT2A'; 
            // =================================================================

            let supabaseClient = null;

            // --- Elementos del DOM ---
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            
            // Formulario Magic Link
            const loginForm = document.getElementById('login-form-magiclink');
            const emailInput = document.getElementById('email-input');
            const loginButton = document.getElementById('login-button');
            const messageBox = document.getElementById('message-box');
            
            // Dashboard
            const userEmail = document.getElementById('user-email');
            const logoutButton = document.getElementById('logout-button');

            // --- Función para mostrar mensajes (solo en login) ---
            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.className = type; // 'success' o 'error'
                messageBox.style.display = 'block';
            }

            // --- Inicialización ---
            try {
                if (typeof supabase === 'undefined' || !supabase.createClient) {
                    throw new Error("Librería de Supabase no cargada.");
                }
                if (supabaseUrl.includes('PEGA_AQUI')) {
                    throw new Error("No has pegado tu URL de Supabase.");
                }
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Cliente Supabase OK para Admin v2.');
                
            } catch (err) { 
                console.error("Error crítico Supabase:", err);
                // Si falla la BBDD, mostrar el login con un error fatal
                loginContainer.style.display = 'block'; 
                showMessage(`Error fatal: ${err.message}`, 'error');
                if (loginButton) loginButton.disabled = true;
            }

            // --- 1. Manejador del Login (Magic Link) ---
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); 
                    if (!supabaseClient) return;

                    const email = emailInput.value.trim();
                    if (!email) {
                        showMessage('Por favor, introduce un email.', 'error');
                        return;
                    }

                    loginButton.disabled = true;
                    loginButton.textContent = 'Enviando...';
                    messageBox.style.display = 'none';

                    try {
                        const { error } = await supabaseClient.auth.signInWithOtp({
                            email: email,
                        });
                        if (error) throw error; 
                        showMessage('¡Éxito! Revisa tu bandeja de entrada (y spam) para el enlace mágico.', 'success');
                        emailInput.value = ''; 

                    } catch (error) {
                        console.error('Error en signInWithOtp:', error);
                        showMessage(`Error: ${error.message || 'No se pudo enviar el enlace.'}`, 'error');
                    } finally {
                        loginButton.disabled = false;
                        loginButton.textContent = 'Enviar Enlace de Acceso';
                    }
                });
            }
            
            // --- 2. Manejador del Logout ---
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    if (!supabaseClient) return;
                    
                    logoutButton.disabled = true;
                    logoutButton.textContent = 'Saliendo...';
                    
                    const { error } = await supabaseClient.auth.signOut();
                    
                    if (error) {
                        console.error('Error al cerrar sesión:', error);
                        alert(`Error al salir: ${error.message}`); // Un simple alert por ahora
                        logoutButton.disabled = false;
                        logoutButton.textContent = 'Cerrar Sesión';
                    }
                    // Si el logout tiene éxito, el "portero" (onAuthStateChange) 
                    // se activará automáticamente y mostrará el login.
                });
            }

            // --- 3. El "Portero" (onAuthStateChange - El Cerebro) ---
            if (supabaseClient) {
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Evento de Auth:', event, session);
                    
                    if (session && session.user) {
                        // --- ESTADO: LOGUEADO ---
                        // El portero dice: "Adelante, jefe"
                        console.log('Usuario logueado:', session.user.email);
                        loginContainer.style.display = 'none';
                        dashboardContainer.style.display = 'block';
                        
                        // Rellenamos los datos del usuario
                        if (userEmail) {
                            userEmail.textContent = session.user.email;
                        }
                        
                    } else {
                        // --- ESTADO: NO LOGUEADO ---
                        // El portero dice: "Enséñame la entrada"
                        console.log('No hay sesión de usuario.');
                        loginContainer.style.display = 'block';
                        dashboardContainer.style.display = 'none';
                    }
                });
            }

        }); // Fin DOMContentLoaded
        
    </script>
</body>
</html>
