<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxe.ai Admin - v4 (Citas Reales!)</title>
    
    <!-- Cargar la librería de Supabase: Forma UMD estable -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <!-- 
      "PLANOS" DE FULLCALENDAR
    -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    
    <!-- Importar Fuente "Inter" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Mismos estilos que v3 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 100%);
            margin: 0; padding: 20px; min-height: 100vh; 
            display: flex; justify-content: center; align-items: center; color: #f0f0f0;
        }
        .admin-container {
            width: 100%; max-width: 900px; padding: 40px;
            background-color: rgba(26, 26, 46, 0.7); backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center;
        }
        
        /* --- ESTILOS DEL LOGIN --- */
        /* (Sin cambios) */
        #login-container h1 { color: #ffffff; font-weight: 700; font-size: 1.8rem; margin-top: 0; margin-bottom: 15px; }
        #login-container p { font-size: 1rem; color: #a0a0c0; margin-bottom: 30px; }
        .input-field { width: calc(100% - 36px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px;
            padding: 16px 18px; font-size: 1rem; background-color: rgba(255, 255, 255, 0.1); color: #ffffff;
            font-family: 'Inter', sans-serif; margin-bottom: 20px; }
        .input-field::placeholder { color: #a0a0c0; }
        .input-field:focus { outline: none; border-color: #00f5d4; box-shadow: 0 0 10px rgba(0, 245, 212, 0.3); }
        .input-field:disabled { background-color: rgba(255, 255, 255, 0.05); color: #777; cursor: not-allowed; }
        #login-button { width: 100%; padding: 16px 18px; background-color: #00f5d4; border: none; color: #1a1a2e; 
            border-radius: 12px; cursor: pointer; text-align: center; font-size: 1rem; font-weight: 700; transition: all 0.2s ease; }
        #login-button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 245, 212, 0.3); }
        #login-button:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }
        #message-box { font-size: 0.9rem; margin-top: 20px; padding: 10px; border-radius: 8px; display: none; }
        #message-box.success { background-color: rgba(0, 245, 212, 0.1); color: #00f5d4; border: 1px solid #00f5d4; }
        #message-box.error { background-color: rgba(255, 82, 82, 0.1); color: #ff5252; border: 1px solid #ff5252; }
        .divider { font-size: 0.9rem; color: #a0a0c0; display: flex; align-items: center; text-align: center; margin: 25px 0; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .divider span { padding: 0 10px; }
        #password-login-button { width: 100%; padding: 16px 18px; background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2); color: #777; border-radius: 12px; cursor: not-allowed; 
            text-align: center; font-size: 1rem; font-weight: 700; }
        
        /* --- ESTILOS DEL DASHBOARD --- */
        /* (Sin cambios) */
        #dashboard-container h1 { color: #ffffff; font-weight: 700; font-size: 1.8rem; margin-top: 0; margin-bottom: 15px; }
        #dashboard-container p { font-size: 1rem; color: #a0a0c0; margin-bottom: 30px; }
        #user-email { color: #00f5d4; font-weight: 700; }
        #logout-button { width: 100%; max-width: 400px; margin: 30px auto 0 auto; padding: 16px 18px; 
            background-color: transparent; border: 1px solid #ff5252; color: #ff5252; border-radius: 12px; 
            cursor: pointer; text-align: center; font-size: 1rem; font-weight: 700; transition: all 0.2s ease; }
        #logout-button:hover { background-color: #ff5252; color: #1a1a2e; box-shadow: 0 4px 15px rgba(255, 82, 82, 0.3); }

        /* --- ESTILOS DEL CALENDARIO --- */
        /* (Sin cambios) */
        #calendario-admin {
            width: 100%;
            margin-top: 30px;
            --fc-border-color: rgba(255, 255, 255, 0.1);
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 8px;
            --fc-event-bg-color: #00f5d4;
            --fc-event-border-color: #00f5d4;
            --fc-event-text-color: #1a1a2e;
            --fc-button-bg-color: #2a2a4e;
            --fc-button-text-color: #f0f0f0;
            --fc-button-border-color: #00f5d4;
            --fc-button-hover-bg-color: #00f5d4;
            --fc-button-hover-text-color: #1a1a2e;
            --fc-button-active-bg-color: #00f5d4;
            --fc-button-active-text-color: #1a1a2e;
            --fc-today-bg-color: rgba(0, 245, 212, 0.1);
        }
        .fc .fc-col-header-cell-cushion,
        .fc .fc-daygrid-day-number { color: #f0f0f0; text-decoration: none; }
        .fc .fc-day-other .fc-daygrid-day-number { color: #555; }
        
    </style>
</head>
<body>

    <!-- Contenedor del Login (Puerta) -->
    <div id="login-container" class="admin-container" style="display: none;">
        <h1>Panel de Control</h1>
        <p>Introduce tu email para recibir un enlace de acceso seguro.</p>
        
        <form id="login-form-magiclink">
            <input type="email" id="email-input" class="input-field" placeholder="tu-email@dominio.com" required>
            <button type="submit" id="login-button">Enviar Enlace de Acceso</button>
        </form>
        
        <div id="message-box"></div>
        
        <div class="divider"><span>o</span></div>
        
        <form id="login-form-password">
            <input type="email" id="email-input-pass" class="input-field" placeholder="tu-email@dominio.com" disabled>
            <input type="password" id="password-input" class="input-field" placeholder="Contraseña" disabled>
            <button type="button" id="password-login-button" disabled>
                Acceder con Contraseña (Próximamente)
            </button>
        </form>
        
    </div>
    
    <!-- Contenedor del Dashboard (La Oficina) -->
    <div id="dashboard-container" class="admin-container" style="display: none;">
        <h1>¡Bienvenido, Rey!</h1>
        <p>Has iniciado sesión como:<br><span id="user-email">cargando...</span></p>
        
        <div style="margin: 30px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
        
        <div id="calendario-admin">
            <!-- FullCalendar aparecerá aquí -->
        </div>
        
        <button id="logout-button">Cerrar Sesión</button>
    </div>

    
    <script type="module">
    
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // === PEGA TUS CLAVES DE SUPABASE AQUÍ ===
            // =================================================================
            const supabaseUrl = 'https://yutttnvtdmjavictfshi.supabase.co'; 
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1dHR0bnZ0ZG1qYXZpY3Rmc2hpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4Nzg3ODAsImV4cCI6MjA3NjQ1NDc4MH0.XYk79f3HGk9LBODR7KMVK33mPkGamfpKSXKW36RlT2A'; 
            // =================================================================

            let supabaseClient = null;

            // --- Elementos del DOM ---
            const loginContainer = document.getElementById('login-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            const loginForm = document.getElementById('login-form-magiclink');
            const emailInput = document.getElementById('email-input');
            const loginButton = document.getElementById('login-button');
            const messageBox = document.getElementById('message-box');
            const userEmail = document.getElementById('user-email');
            const logoutButton = document.getElementById('logout-button');
            const calendarEl = document.getElementById('calendario-admin');
            let adminCalendar = null; 

            // --- Función para mostrar mensajes (solo en login) ---
            function showMessage(message, type = 'success') { /* (igual) */ }

            // --- Inicialización ---
            try {
                if (typeof supabase === 'undefined' || !supabase.createClient) { throw new Error("Supabase no cargado."); }
                // ¡¡¡OJO!!! Pega tus claves aquí abajo, si no, peta
                if (supabaseUrl.includes('PEGA_AQUI')) { throw new Error("¡Pega tu URL de Supabase, nano!"); }
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log('[DEBUG v4] Cliente Supabase OK.');
            } catch (err) { 
                 console.error("[DEBUG v4] Error crítico Supabase:", err);
                 if(loginContainer) loginContainer.style.display = 'block'; 
                 showMessage(`Error fatal: ${err.message}`, 'error');
                 if (loginButton) loginButton.disabled = true;
            }

            // --- 1. Manejador del Login (Magic Link) ---
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => { /* (igual) */ });
            }
            
            // --- 2. Manejador del Logout ---
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => { /* (igual) */ });
            }

            // --- ¡NUEVO! CEREBRO v4: EL "INTERRUPTOR" DEL CALENDARIO ---
            function cargarCalendario(userId, userEmail) {
                console.log(`[DEBUG v4] Cargando calendario para el jefe: ${userEmail}`);
                
                if (!calendarEl || typeof FullCalendar === 'undefined') {
                    console.error('[DEBUG v4] ¡Fallo! No se encuentra #calendario-admin o FullCalendar.js');
                    return;
                }
                
                if (adminCalendar) {
                    adminCalendar.refetchEvents(); // Si ya existe, solo recarga las citas
                    return;
                }

                // ¡Aquí se crea la magia!
                adminCalendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', // Vista de mes
                    locale: 'es', // ¡En Español!
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    
                    // --- ¡¡AQUÍ ESTÁ EL PUTO "TRANSPLANTE DE CEREBRO"!! ---
                    // Borramos la cita falsa y le decimos que "cargue" (`async`)
                    // las citas de verdad desde Supabase.
                    events: async function(fetchInfo) {
                        console.log("[DEBUG v4] El calendario pide citas...");
                        if (!supabaseClient) {
                             console.error("Supabase no listo"); return [];
                        }
                        
                        try {
                            // ¡AQUÍ ESTÁ LA PUTA MAGIA!
                            // Usamos la "llave" (RLS Policy de SELECT) que creamos.
                            // ¡Pedimos el nombre del servicio usando un JOIN!
                            
                            // ¡¡¡OJO!!! ¡Esto pide TODAS las citas!
                            // En el futuro (cuando tengamos el `business_id` en el login),
                            // filtraremos por el negocio del jefe.
                            const { data, error } = await supabaseClient
                                .from('appointments')
                                .select(`
                                    customerName, 
                                    dateTime, 
                                    services ( name ) 
                                `); 
                                // ¡¡¡IMPORTANTE!!! Para que esto (el JOIN) funcione,
                                // ¡tienes que tener una "foreign key" (llave foránea)
                                // en tu tabla 'appointments' que apunte a 'services'!
                                // ¡Y la tabla 'services' necesita una RLS de SELECT!

                            if (error) throw error;

                            console.log("[DEBUG v4] Citas recibidas de Supabase:", data);

                            // "Traducimos" las citas para el calendario
                            const citasTraducidas = data.map(cita => {
                                // Fallback por si el JOIN falla (ej: servicio borrado)
                                const serviceName = cita.services ? cita.services.name : 'Servicio Borrado';
                                return {
                                    title: `${cita.customerName} (${serviceName})`, // Ej: "Nano (Corte Pelo)"
                                    start: cita.dateTime,    // La hora que reservó
                                    allDay: false
                                };
                            });
                            
                            return citasTraducidas; // Devolvemos las citas REALES.

                        } catch (err) {
                            console.error('[DEBUG v4] ¡Error al leer las citas! (¿RLS? ¿JOIN?):', err.message);
                            alert('Error al cargar las citas: ' + err.message);
                            return []; // Devolvemos un array vacío si falla
                        }
                    }
                });

                adminCalendar.render(); // ¡Dibuja el calendario!
            }


            // --- 4. El "Portero" (onAuthStateChange - ¡ACTUALIZADO!) ---
            if (supabaseClient) {
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log(`[DEBUG v4] Evento Auth Recibido: ${event}`, session);
                    
                    if (session && session.user) {
                        // --- ESTADO: LOGUEADO ---
                        console.log('[DEBUG v4] ¡SESIÓN DETECTADA!', session.user.email);
                        loginContainer.style.display = 'none';
                        dashboardContainer.style.display = 'block';
                        
                        if (userEmail) {
                            userEmail.textContent = session.user.email;
                        }
                        
                        // ¡El "portero" llama al "interruptor" del calendario!
                        cargarCalendario(session.user.id, session.user.email);
                        
                    } else {
                        // --- ESTADO: NO LOGUEADO ---
                        console.log('[DEBUG v4] NO hay sesión detectada.');
                        loginContainer.style.display = 'block';
                        dashboardContainer.style.display = 'none';
                    }
                });
            }

        }); // Fin DOMContentLoaded
        
    </script>
</body>
</html>

